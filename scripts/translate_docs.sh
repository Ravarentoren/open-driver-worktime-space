#!/usr/bin/env bash
set -euo pipefail

SOURCE_LANG="en"
TARGET_LANGS=("cs" "de" "fr" "ru")
DOCS_DIR="docs"
DEBUG=true

log() {
  [[ "$DEBUG" == "true" ]] && echo "[DEBUG] $1"
}

# ---------- PROTECT ----------
protect_content() {
  local input
  input=$(cat)

  # metadata blocks
  while [[ "$input" == *"<!--"* ]]; do
    local before="${input%%<!--*}"
    local rest="${input#*<!--}"
    local block="<!--${rest%%-->*}-->"
    local token="@@ODWS_META_${META_ID}@@"
    META_MAP["$token"]="$block"
    input="${before}${token}${rest#*-->}"
    ((META_ID++))
  done

  # URLs (safe version)
  for url in $(grep -oE 'https?://[^[:space:]]+' <<<"$input"); do
    local token="@@ODWS_URL_${URL_ID}@@"
    URL_MAP["$token"]="$url"
    input="${input//$url/$token}"
    ((URL_ID++))
  done

  echo "$input"
}

# ---------- RESTORE ----------
restore_content() {
  local input
  input=$(cat)

  for token in "${!META_MAP[@]}"; do
    input="${input//$token/${META_MAP[$token]}}"
  done

  for token in "${!URL_MAP[@]}"; do
    input="${input//$token/${URL_MAP[$token]}}"
  done

  echo "$input"
}

# ---------- TRANSLATE FILE ----------
translate_file() {
  local src="$1" lang="$2" dst="$3"

  log "Processing $src → $dst"

  declare -gA META_MAP=()
  declare -gA URL_MAP=()
  META_ID=0
  URL_ID=0

  protected=$(protect_content < "$src")
  translated=$(echo "$protected" | trans -b :"$lang" || echo "$protected")
  restored=$(echo "$translated" | restore_content)

  {
    echo "> ⚠ This file is auto-generated from docs/en/$(basename "$src")."
    echo "> The authoritative version is the English original."
    echo "> Do not edit this file manually."
    echo
    echo "$restored"
  } > "$dst"
}

# ---------- DOCS ----------
for lang in "${TARGET_LANGS[@]}"; do
  mkdir -p "$DOCS_DIR/$lang"
  for f in "$DOCS_DIR/$SOURCE_LANG"/*.md; do
    translate_file "$f" "$lang" "$DOCS_DIR/$lang/$(basename "$f")"
  done
done

# ---------- README ----------
if [[ -f README.md ]]; then
  for lang in "${TARGET_LANGS[@]}"; do
    declare -gA META_MAP=()
    declare -gA URL_MAP=()
    META_ID=0
    URL_ID=0

    protected=$(protect_content < README.md)
    translated=$(echo "$protected" | trans -b :"$lang" || echo "$protected")
    restored=$(echo "$translated" | restore_content)

    {
      echo "> ⚠ This is an automatically generated translation of README.md."
      echo "> The authoritative version is README.md (English)."
      echo "> Do not edit this file manually."
      echo
      echo "$restored"
    } > "README.$lang.md"
  done
fi

log "Translation completed successfully."
