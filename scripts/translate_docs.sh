#!/usr/bin/env bash
set -euo pipefail

# ============================================================
# ODWS Documentation Translation Script
#
# Behavior:
# - Recursively translates docs/en/**.md
# - Preserves directory structure
# - Translates ONLY missing files by default
#
# Flags:
#   DEBUG=true   → verbose decision log
#   FORCE=true   → retranslate everything
#   OFFLINE=true → no network, copy-only
# ============================================================

SOURCE_LANG="en"
TARGET_LANGS=("cs" "de" "fr" "ru")
DOCS_DIR="docs"

DEBUG="${DEBUG:-false}"
FORCE="${FORCE:-false}"
OFFLINE="${OFFLINE:-false}"

# ------------------------------------------------------------
# Logging helpers
# ------------------------------------------------------------

debug() {
  [[ "$DEBUG" == "true" ]] && echo "[DEBUG] $*"
}

info() {
  echo "[INFO] $*"
}

# ------------------------------------------------------------
# Translation backend
# ------------------------------------------------------------

translate() {
  local lang="$1"

  if [[ "$OFFLINE" == "true" ]]; then
    cat
    return
  fi

  if command -v trans >/dev/null 2>&1; then
    trans -b :"$lang" 2>/dev/null || cat
  else
    cat
  fi
}

# ------------------------------------------------------------
# Translate one file if needed
# ------------------------------------------------------------

translate_file() {
  local src="$1"
  local lang="$2"
  local dst="$3"

  if [[ -f "$dst" && "$FORCE" != "true" ]]; then
    debug "Skipping existing: $dst"
    return
  fi

  mkdir -p "$(dirname "$dst")"

  if [[ -f "$dst" ]]; then
    info "Recreating: $dst"
  else
    info "Creating:   $dst"
  fi

  # Metadata block (YAML front matter)
  metadata="$(sed -n '1,/^---$/p' "$src")"
  body="$(sed '1,/^---$/d' "$src")"

  {
    echo "> ⚠ This file is auto-generated from docs/en/${src#docs/en/}."
    echo "> The authoritative version is the English original."
    echo "> Do not edit this file manually."
    echo
    echo "$metadata"
    echo
    printf "%s\n" "$body" | translate "$lang"
  } > "$dst"
}

# ------------------------------------------------------------
# Main
# ------------------------------------------------------------

debug "Starting documentation translation"

find "$DOCS_DIR/$SOURCE_LANG" -type f -name "*.md" | while read -r src; do
  rel_path="${src#$DOCS_DIR/$SOURCE_LANG/}"

  for lang in "${TARGET_LANGS[@]}"; do
    dst="$DOCS_DIR/$lang/$rel_path"
    translate_file "$src" "$lang" "$dst"
  done
done

debug "Translation finished"
