#!/usr/bin/env bash
set -euo pipefail

SOURCE_LANG="en"
TARGET_LANGS=("cs" "de" "fr" "ru")
DOCS_DIR="docs"

DEBUG="${DEBUG:-false}"
OFFLINE="${OFFLINE:-false}"

log() {
  [[ "$DEBUG" == "true" ]] && echo "[DEBUG] $*"
}

translate() {
  local lang="$1"
  if [[ "$OFFLINE" == "true" ]]; then
    cat
  else
    trans -b :"$lang" 2>/dev/null || cat
  fi
}

translate_file() {
  local src="$1"
  local lang="$2"
  local dst="$3"

  log "→ $src → $dst"

  # 1️⃣ metadata = první HTML komentář (pokud existuje)
  metadata="$(sed -n '1,/-->/p' "$src")"

  # 2️⃣ tělo = vše ZA prvním HTML komentářem
  body="$(sed '1,/-->/d' "$src")"

  {
    echo "> ⚠ This file is auto-generated from docs/en/$(basename "$src")."
    echo "> The authoritative version is the English original."
    echo "> Do not edit this file manually."
    echo
    echo "$metadata"
    echo
    printf "%s\n" "$body" | translate "$lang"
  } > "$dst"
}

log "Starting translation"

for lang in "${TARGET_LANGS[@]}"; do
  mkdir -p "$DOCS_DIR/$lang"

  for file in "$DOCS_DIR/$SOURCE_LANG"/*.md; do
    translate_file "$file" "$lang" "$DOCS_DIR/$lang/$(basename "$file")"
  done
done

log "Done"
